<html>
  <head>
    <title>Temperatures at ruibm.com</title>
    <script src="static/jquery-2.0.3.min.js"></script>
    <script src="static/Chart.bundle.min.js"></script>
    <style>
      .graph {
        max-width: 800px;
        min-width: 100px;
        padding: 10px;
      }

      .latest_temperature {
      }
    </style>
  </head>
  <body>
    <h1><a href="/">Temperature from the RaspberryPi </a></h1>
    <ul>
      <li><a href="https://github.com/ruibm/temperpi">This project on GitHub - temperpi</a></li>
      <li><a href="http://ruibm.com">My homepage</a></li>
    </ul>

    <h2>Latest Temperature:
      <span class="latest_temperature" id="latest_temperature">loading...</span>
    </h2>

    % if refresh:
      <a href="?refresh=false">Stop auto refreshing graphs</a>
    % else:
      <a href="?refresh=true">Auto refresh graphs</a>
    % endif:

    <form method="GET" target="self">
      Last DateTime: <input type="text" name="last_datetime" value="${last_datetime}" size="21" />
      <input type="submit" value="Change DateTime" />
      <input type="hidden" name="refresh" value="${refresh}" />
    </form>

    <h3>Temperature 1 Day (Celsius)</h3>
    <div class="graph">
      <canvas id="1DayChart" width="1000" height="500"></canvas>
    </div>

    <h3>Temperature 1 Week (Celsius)</h3>
    <div class="graph">
      <canvas id="1WeekChart" width="1000" height="500"></canvas>
    </div>

    <h3>Temperature 1 Month (Celsius)</h3>
    <div class="graph">
      <canvas id="1MonthChart" width="1000" height="500"></canvas>
    </div>

    <h3>Temperature 1 Hour (Celsius)</h3>
    <div class="graph">
      <canvas id="1HourChart" width="1000" height="500"></canvas>
    </div>

    <script>

      function get_tz_offset_minutes() {
        return new Date().getTimezoneOffset();
      }

      function update_temperature() {
        var path = "latest_temperature?tz_offset_minutes=" +
            get_tz_offset_minutes();
        $.getJSON(path, function(data) {
          var span = $("#latest_temperature");
          if ("temperature" in data) {
            var temp = data["temperature"];
            span.text(temp + " Celsius (" + data["date"] + ")");
          } else {
            span.text('');
          }
        });
      }

      function update_chart(canvas_id, start_millis, last_millis) {
        $.getJSON("json?start_millis=" + start_millis +
                  "&last_millis=" + last_millis +
                  "&tz_offset_minutes=" + get_tz_offset_minutes(),
                  function(data) {
          // Get context with jQuery - using jQuery's .get() method.
          var ctx = $("#" + canvas_id).get(0).getContext("2d");
          var config = {
            type: 'line',
            data: data,
            options: {
              responsive: true,
              title: {
                display: false,
                text: ''
              },
              tooltips: {
                mode: 'index',
                intersect: false,
              },
              hover: {
                mode: 'nearest',
                intersect: true
              },
              scales: {
                xAxes: [{
                  display: true,
                  scaleLabel: {
                    display: true,
                    labelString: 'Timestamp'
                  }
                }],
                yAxes: [{
                  display: true,
                  scaleLabel: {
                    display: true,
                    labelString: 'Temperature (Celsius)'
                  },
                  ticks: {
                    beginAtZero: false,
                  },
                }]
              }
            }
          };
          var new_chart = new Chart(ctx, config);
        });
      }

      function update_all_charts() {
        var last_millis = "${last_millis}"
        hour_in_millis = 60 * 60 * 1000
        update_chart("1DayChart", last_millis - 24 * hour_in_millis, last_millis);
        update_chart("1WeekChart", last_millis - 7 * 24 * hour_in_millis, last_millis);
        update_chart("1MonthChart", last_millis - 31 * 24 * 60 * 60 * 1000, last_millis);
        update_chart("1HourChart", last_millis - 1 * hour_in_millis, last_millis);
        update_temperature();
      }

      // A $( document ).ready() block.
      $( document ).ready(function() {
        console.log( "ready!" );
        update_all_charts();
        % if refresh:
        setInterval(update_all_charts, 60 * 1000);
        % endif
      });

    </script>

  </body>
<html>
